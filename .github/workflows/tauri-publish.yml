name: Rebuild Tauri Bundles

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing release tag (for example: v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: tauri-rebuild-${{ inputs.tag }}
  cancel-in-progress: false

jobs:
  publish-tauri:
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin --bundles dmg
            asset_os: macos
            asset_arch: arm64
            asset_kind: installer
            upload_updater: true
          - platform: macos-latest
            args: --target x86_64-apple-darwin --bundles dmg
            asset_os: macos
            asset_arch: x64
            asset_kind: installer
            upload_updater: true
          - platform: ubuntu-22.04
            args: --bundles deb,rpm
            asset_os: linux
            asset_arch: x64
            asset_kind: installer
            upload_updater: false
          - platform: ubuntu-22.04
            args: --bundles appimage
            asset_os: linux
            asset_arch: x64
            asset_kind: standalone
            upload_updater: true
          - platform: windows-latest
            args: --bundles nsis
            asset_os: windows
            asset_arch: x64
            asset_kind: installer
            upload_updater: true
          - platform: windows-latest
            args: --bundles msi
            asset_os: windows
            asset_arch: x64
            asset_kind: installer
            upload_updater: false

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS targets
        if: matrix.platform == 'macos-latest'
        run: rustup target add aarch64-apple-darwin x86_64-apple-darwin

      - name: Cache Rust build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev libdbus-1-dev patchelf

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Sync app version from release tag
        run: node ./scripts/release/sync-version.mjs --version "${{ inputs.tag }}"

      - name: Resolve release id
        id: release_meta
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ inputs.tag }}';
            const { data } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag,
            });
            core.setOutput('release_id', String(data.id));

      - name: Build and upload bundles
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tag }}
          releaseId: ${{ steps.release_meta.outputs.release_id }}
          args: ${{ matrix.args }}
          assetNamePattern: "object0_[version]_${{ matrix.asset_os }}_${{ matrix.asset_arch }}_${{ matrix.asset_kind }}[ext]"
          uploadUpdaterJson: ${{ matrix.upload_updater }}
          uploadUpdaterSignatures: ${{ matrix.upload_updater }}

  publish-standalone-binaries:
    needs: publish-tauri
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin --no-bundle
            asset_os: macos
            asset_arch: arm64
          - platform: macos-latest
            args: --target x86_64-apple-darwin --no-bundle
            asset_os: macos
            asset_arch: x64
          - platform: ubuntu-22.04
            args: --no-bundle
            asset_os: linux
            asset_arch: x64
          - platform: windows-latest
            args: --no-bundle
            asset_os: windows
            asset_arch: x64

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS targets
        if: matrix.platform == 'macos-latest'
        run: rustup target add aarch64-apple-darwin x86_64-apple-darwin

      - name: Cache Rust build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev libdbus-1-dev patchelf

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Sync app version from release tag
        run: node ./scripts/release/sync-version.mjs --version "${{ inputs.tag }}"

      - name: Resolve release id
        id: release_meta
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ inputs.tag }}';
            const { data } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag,
            });
            core.setOutput('release_id', String(data.id));

      - name: Build and upload standalone binaries
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tag }}
          releaseId: ${{ steps.release_meta.outputs.release_id }}
          args: ${{ matrix.args }}
          uploadPlainBinary: true
          assetNamePattern: "object0_[version]_${{ matrix.asset_os }}_${{ matrix.asset_arch }}_standalone[ext]"
          uploadUpdaterJson: false
          uploadUpdaterSignatures: false
